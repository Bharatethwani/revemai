import { serve } from "https://deno.land/std@0.168.0/http/server.ts"

// 1. IMPROVED CORS: Mobile browsers require explicit headers
const corsHeaders = {
  "Access-Control-Allow-Origin": "*",
  "Access-Control-Allow-Headers": "authorization, x-client-info, apikey, content-type, x-device-type",
  "Access-Control-Allow-Methods": "POST, OPTIONS",
  "Access-Control-Max-Age": "86400",
}

serve(async (req) => {
  // 2. Handle OPTIONS (Preflight) correctly for Mobile Chrome/Safari
  if (req.method === "OPTIONS") {
    return new Response('ok', {
      headers: corsHeaders,
    })
  }

  try {
    // Standard response headers
    const responseHeaders = {
      ...corsHeaders,
      "Content-Type": "application/json",
    }

    // 3. Robust Body Parsing
    const body = await req.json();
    const { businessId, rating, input } = body;

    if (!businessId || !rating) {
      return new Response(
        JSON.stringify({ error: "Missing businessId or rating" }),
        { status: 400, headers: responseHeaders }
      )
    }

    const openaiKey = Deno.env.get("OPENAI_API_KEY")
    const supabaseUrl = Deno.env.get("SUPABASE_URL")
    const serviceRoleKey = Deno.env.get("SUPABASE_SERVICE_ROLE_KEY")

    // 4. SUPABASE FETCH FIX: Use simpler URL template for mobile compatibility
    const supabaseEndpoint = `${supabaseUrl}/rest/v1/businesses?id=eq.${businessId}&select=*`;
    
    const businessRes = await fetch(supabaseEndpoint, {
      method: 'GET',
      headers: {
        'apikey': serviceRoleKey,
        'Authorization': `Bearer ${serviceRoleKey}`,
        'Content-Type': 'application/json',
      },
    })

    const businessData = await businessRes.json()
    if (!businessData || businessData.length === 0) {
      return new Response(
        JSON.stringify({ error: "Business record not found in DB" }),
        { status: 404, headers: responseHeaders }
      )
    }

    const business = businessData[0]

    // 5. OPENAI CALL: Streamlined for faster mobile response
    const aiRes = await fetch("https://api.openai.com/v1/chat/completions", {
      method: "POST",
      headers: {
        "Content-Type": "application/json",
        "Authorization": `Bearer ${openaiKey}`,
      },
      body: JSON.stringify({
        model: "gpt-4o-mini",
        temperature: 0.8,
        messages: [
          {
            role: "system",
            content: `You are a professional review writer for RevMeAI.com. 
            Generate 5 natural, spam-safe Google reviews for ${business.business_name} in ${business.city}.
            Category: ${business.category}. Rating: ${rating} stars.
            Languages: ${business.language || "English, Hindi"}.
            Rules: No emojis, mix of English and Hinglish, everyday Indian style.
            Output: ONLY a plain JSON array of objects: [{"review": "text"}]`
          },
          ...(input ? [{ role: "user", content: `Context: ${input}` }] : []),
        ],
      }),
    })

    const aiData = await aiRes.json()
    const content = aiData.choices[0].message.content;

    // 6. JSON CLEANING: AI sometimes adds markdown blocks ```json ... ``` which breaks JSON.parse
    const cleanJson = content.replace(/```json/g, "").replace(/```/g, "").trim();
    const reviews = JSON.parse(cleanJson);

    return new Response(
      JSON.stringify({ review: reviews }),
      { status: 200, headers: responseHeaders }
    )

  } catch (err) {
    console.error("Function Error:", err.message)
    return new Response(
      JSON.stringify({ error: err.message }),
      { 
        status: 500, 
        headers: { ...corsHeaders, "Content-Type": "application/json" } 
      }
    )
  }
})
