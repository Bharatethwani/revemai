<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Smart AI Review Assistant</title>
    <style>
        :root { --p: #2563eb; --bg: #f8fafc; --txt: #0f172a; --sec: #64748b; }
        body { margin: 0; font-family: -apple-system, system-ui, sans-serif; background: var(--bg); color: var(--txt); display: flex; justify-content: center; align-items: center; min-height: 100vh; padding: 15px; }
        .card { width: 100%; max-width: 400px; background: #fff; padding: 25px; border-radius: 20px; box-shadow: 0 10px 25px rgba(0,0,0,0.05); border: 1px solid #e2e8f0; }
        .header { text-align: center; margin-bottom: 20px; }
        #status { font-size: 14px; color: var(--sec); margin-top: 8px; }
        .stars { display: flex; justify-content: center; gap: 10px; margin: 20px 0; font-size: 40px; }
        .star { cursor: pointer; color: #e2e8f0; transition: 0.2s; }
        .star.active { color: #f59e0b; }
        .review-track { display: flex; gap: 10px; overflow-x: auto; padding-bottom: 10px; scroll-snap-type: x mandatory; -webkit-overflow-scrolling: touch; }
        .review-card { flex: 0 0 85%; padding: 15px; border: 1px solid #e2e8f0; border-radius: 12px; font-size: 14px; scroll-snap-align: start; cursor: pointer; background: #fff; }
        .review-card.selected { border-color: var(--p); background: #eff6ff; }
        textarea { width: 100%; min-height: 100px; border-radius: 12px; border: 1px solid #e2e8f0; padding: 12px; margin-top: 10px; font-size: 14px; outline: none; }
        textarea:focus { border-color: var(--p); }
        button { width: 100%; margin-top: 15px; padding: 15px; border-radius: 12px; border: none; background: var(--p); color: #fff; font-weight: 600; cursor: pointer; font-size: 16px; }
        button:disabled { background: #cbd5e1; color: #94a3b8; }
        .error-text { color: #ef4444 !important; }
    </style>
</head>
<body>

<div class="card">
    <div class="header">
        <h2 id="bizName">AI Review Assistant</h2>
        <p id="status">Verifying Business...</p>
    </div>

    <div class="stars">
        <span class="star" data-v="1">★</span>
        <span class="star" data-v="2">★</span>
        <span class="star" data-v="3">★</span>
        <span class="star" data-v="4">★</span>
        <span class="star" data-v="5">★</span>
    </div>

    <div id="aiResult" style="display:none"></div>
    <textarea id="userInput" placeholder="Tap stars to see AI suggestions..."></textarea>
    <button id="cta" disabled>Please wait...</button>
</div>

<script type="module">
    import { createClient } from 'https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/+esm';

    const supabase = createClient(
        'https://iwhxyqczdfapprigyrpr.supabase.co',
        'sb_publishable_d0EbyoBusVfRDhX8Zr81Nw_KT0qXUiq'
    );

    const status = document.getElementById('status');
    const bizName = document.getElementById('bizName');
    const btn = document.getElementById('cta');
    const input = document.getElementById('userInput');
    const aiResult = document.getElementById('aiResult');
    const stars = document.querySelectorAll('.star');

    let googleUrl = null;
    let bId = null;

    // --- FIX: Specific parsing for your URL structure (/r/ID) ---
    function getID() {
        const path = window.location.pathname; // e.g. "/r/348a4173..."
        const segments = path.split('/').filter(s => s.length > 0);
        
        // If your URL is domain.com/r/ID, the ID is the last segment
        const id = segments[segments.length - 1] || "";
        return id.split('?')[0].trim().toLowerCase();
    }

    async function initBusiness() {
        bId = getID();
        console.log("Business ID extracted:", bId);

        if (!bId || bId.length < 20) {
            status.innerHTML = '<span class="error-text">Invalid Link</span>';
            return;
        }

        try {
            const { data, error } = await supabase
                .from('businesses')
                .select('review_url, name')
                .eq('id', bId)
                .maybeSingle();

            if (error) throw error;

            if (data) {
                googleUrl = data.review_url;
                bizName.innerText = data.name;
                status.innerText = "Select stars for professional suggestions";
                btn.innerText = "Copy & Go to Google";
                btn.disabled = false;
            } else {
                status.innerHTML = '<span class="error-text">Business not registered</span>';
            }
        } catch (e) {
            console.error("Supabase error:", e);
            status.innerHTML = '<span class="error-text">Connection error. Please refresh.</span>';
        }
    }

    stars.forEach(s => {
        s.onclick = async () => {
            const val = s.dataset.v;
            stars.forEach(st => st.classList.toggle('active', st.dataset.v <= val));
            
            if (!bId) return;

            aiResult.style.display = 'block';
            aiResult.innerHTML = '<div style="text-align:center; font-size:13px; padding:10px; color:#64748b;">AI is writing...</div>';

            try {
                const { data } = await supabase.functions.invoke('generate-review', {
                    body: { businessId: bId, rating: parseInt(val), input: input.value }
                });

                if (data?.review) {
                    aiResult.innerHTML = '<div class="review-track"></div>';
                    const track = aiResult.querySelector('.review-track');
                    data.review.forEach(r => {
                        const card = document.createElement('div');
                        card.className = 'review-card';
                        card.innerText = r.review;
                        card.onclick = () => {
                            input.value = r.review;
                            document.querySelectorAll('.review-card').forEach(c => c.classList.remove('selected'));
                            card.classList.add('selected');
                        };
                        track.appendChild(card);
                    });
                }
            } catch (e) {
                aiResult.innerHTML = '';
            }
        };
    });

    btn.onclick = () => {
        const text = input.value.trim();
        if (!text) return alert("Write or select a review first!");
        
        // Use Clipboard API
        navigator.clipboard.writeText(text).then(() => {
            btn.innerText = "Copied! Opening Google...";
            setTimeout(() => { if (googleUrl) window.location.href = googleUrl; }, 1000);
        }).catch(() => {
            // Fallback for older Android Chrome
            input.select();
            document.execCommand('copy');
            if (googleUrl) window.location.href = googleUrl;
        });
    };

    // Load as soon as script parses
    initBusiness();
</script>

</body>
</html>
